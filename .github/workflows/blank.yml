name: Terraform-workflow-WE

on: 
  workflow_dispatch:
  # push:
    # branches: [ main ]
    # paths:
    #   - '**.tf'
    
env:
  TF_IN_AUTOMATION: true
  TF_INPUT: false
  
permissions:
  id-token: write
  contents: read

jobs:
  plan:
    runs-on: self-hosted
    container: mcr.microsoft.com/azure-cli:2.63.0 
    
    steps:
      - name: Checkout foundation-azure-infra-app-we Repository
        uses: actions/checkout@v4
        with:
          path: main-repo
          
      
      - name: Checkout 002-ccoe-infra-modules
        uses: actions/checkout@v4
        with:
          repository: bkainth1/terraform-repo
          ref: main
          path: 002-ccoe-infra-modules
          #token: ${{ secrets.TERRAFORM_REPO }}
      # - name: Install Azure cli
      #   run: |
      #       curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          
      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          

      - name: Azure CLI script
        uses: azure/CLI@v1
        with:
          azcliversion: latest
          inlineScript: |
            az account show

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        
      - name: Terraform init
        working-directory: main-repo
        run: |
            terraform init
            

      - name: Terraform Validate
        working-directory: main-repo
        run: |
            terraform validate

      - name: Terraform Plan
        working-directory: main-repo
        run: |
            terraform plan -out=tfplan
            

      - name: Save Plan
        uses: actions/upload-artifact@v4
        with:
          name: tf-plan-${{ github.run_number }}
          path: |
            main-repo/tfplan
            main-repo/paln.txt

      - name: Terraform Apply
        working-directory: main-repo
        run: |
            terraform apply --auto-approve
